<title>新手上路</title>

<meta charset="utf-8">

<link rel="stylesheet" href="../../../style.css">

<link rel="prev" href="consistency.html">

<link rel="next" href="api.html">

<script src="../../../script.js"></script>

<h2>新手上路</h2>

<p>在本节中, 我们将会快速的浏览下CouchDB的各种特性, 熟悉<em>Futon</em>--CouchDB自带的管理界面. 我们会创建第一个文档并体验CouchDB的视图. 在开始前, 请查看<a href="source.html">附录D, 从源代码安装</a>中关于您的操作系统的安装步骤. 在继续前进之前, 请按照这些指示, 安装好CouchDB.

<h3 id="go">在任何系统上都能运行!</h3>

<p>我们会用<code>curl</code>来快速的看看CouchDB的一些零散的<em>API</em>. 请注意这只是其中的一种和CouchDB沟通的方式. 我们将在本书的后面展示更多的方式. <code>curl</code>的有趣之处在于, 它给了你对原生HTTP请求的控制能力, 并且让你能准确的看到数据库底层到底在干些什么.

<p>确认CouchDB已经在运行后, 输入:

<pre>
curl http://127.0.0.1:5984/
</pre>

<p>这会发一个<code>GET</code>请求到你新装的CouchDB实例.

<p>得到的回应看起来应该像这样子:

<pre>
{"couchdb":"Welcome","version":"0.10.1"}
</pre>

<p>没什么特别的, CouchDB正向你问好呢, 带着它的版本号.

<p>接下来, 我们可以得到所有数据库的一个列表:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<p>我们在前一个请求里加的只有 <code>_all_dbs</code> 这个字符串.

<p>回应看起来像是这个样子:

<pre>
[]
</pre>

<p>哦, 对, 我们还没有创建任何数据库! 我们看到的是一个空列表.

<div class="aside note">

<p><code>curl</code>命令的默认方法是<code>GET</code>. 可以使用<code>curl -X POST</code>来发送一个<code>POST</code>请求. 为了更好的我们的终端历史配合, 即便是在发送<code>GET</code>请求时, 我们也使用了<code>-X</code>的选项. 这样如果下一次我们想要发送<code>POST</code>请求, 就只需要改变方法名就可以了.

<p>在底层, HTTP其实做了比上述例子中更多一点的事情. 如果您以于这些细节感兴趣, 可以使用<code>-v</code>选项(比如, <code>curl -vX GET</code>), 这样<code>curl</code>就会显示出它是在向哪里发起连接, 发送的请求头, 以及接收回来的返回头. 这对于调试来说非常有用.

</div>

<p>让我们来创建一个数据库:

<pre>
curl -X PUT http://127.0.0.1:5984/baseball
</pre>

<p>CouchDB会回应:

<pre>
{"ok":true}
</pre>

<p>再取一次数据库列表, 这次会显示一些有用的结果:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<pre>
["baseball"]
</pre>

<div class="aside note">

<p>我们应该在这里提一下<em>JavaScript Object Notation (JSON)</em>, CouchDB的数据格式. JSON是一个以JavaScrip语法为基础的轻量级数据交换格式. 因为JSON和JavaScript原生的兼容, 所以浏览器就是CouchDB的一个理想的客户端.

<p>方括号(<code>[]</code>)代表排序的列表, 大括号(<code>{}</code>)代表key/value字典. key必须是字符串, 以引号(<code>"</code>)包含, value可以是字符吕, 数字, 布尔, 列表, 或者key/value字典. 要了解更多的关于JSON的描述, 请查看<a href="json.html">附录E, JSON初步</a>.

</div>

<p>让我们创建另一个数据库:

<pre>
curl -X PUT http://127.0.0.1:5984/baseball
</pre>

<p>CouchDB会回应:

<pre>
{"error":"file_exists","reason":"The database could not be created, the file already exists."}
</pre>

<p>我们已经有了一个同名的数据库, 所以CouchDB会返回一个错误. 让我们试着换一个数据库名称.

<pre>
curl -X PUT http://127.0.0.1:5984/plankton
</pre>

<p>CouchDB会回应:

<pre>
{"ok":true}
</pre>

<p>再一次获取数据库列表, 现在可以看到一些有用的东西了:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<p>CouchDB会回应:

<pre>
["baseball", "plankton"]
</pre>

<p>为了演示, 让我们删除第二个数据库:

<pre>
curl -X DELETE http://127.0.0.1:5984/plankton
</pre>

<p>CouchDB会回应:

<pre>
{"ok":true}
</pre>

<p>现在数据库列表和先前的一样了:

<pre>
curl -X GET http://127.0.0.1:5984/_all_dbs
</pre>

<p>CouchDB回应:

<pre>
["baseball"]
</pre>

<p>为了减略, 我们跳过了和文档打交道的部分, 因为下一部分会讲到一个不同的但应该更加简单的方法来和CouchDB打交道, 那里会包含和文档打交道的这一部分. 当我们讲解这些例子时, 请记住, 在底层应用程序所作的事和你现在手工在做的是完全一样的. 任何事情都是用<code>GET</code>, <code>PUT</code>, <code>POST</code>和<code>DELETE</code>来操作一个URI.

<h3 id="welcome">欢迎来到Futon</h3>

<p>在看过CouchDB的原生API后, 让我们来玩玩Futon, CouchDB自带的管理界面. Futon提供了访问CouchDB特性的全部权限, 而且它使得理解一些更加复杂的概念变得简单. 用Futon, 我们可以创建和销毁数据库, 查看和编辑文档, 建立和运行MapReduce视图, 还能在数据库之间进行复制.

<p>想要在你的浏览器里打开Futon, 访问:

<pre>
http://127.0.0.1:5984/_utils/
</pre>

<p>如果你运行的是0.9及其以后的版本, 你应该会看到像<a href="#figure/1">图1, "Futon欢迎界面"</a>类似的界面. 在之后的章节里, 我们会关注于用服务器端语言, 比如Ruby和Python来使用CouchDB. 而现在, 本章节正是一个好机会, 可以展示一个只使用CouchDB的集成Web Server来构建动态Web应用的例子.

<p>在全新安装一个CouchDB后的第一件事就是运行测试套件来确认正常工作. 这可以保证将来无论我们遇到什么问题都不是因为某些安装时的烦人原因而造成的. Futon测试套件里的失败会有一个红色标记, 告诉我们在使用一个可能有问题的数据库之前, 需要再三检查安装是否没有问题, 以免当出现不是我们所期待的事情时陷入混乱.</p>

<div class="figure" id="figure/1">

<img src="tour/01.png">

<p class="caption">图1. Futon欢迎界面

</div>

<div class="aside warning">

<p>当通过 <code>localhost</code> 访问时, 有些网络配置可能会导致复制测试失败. 可以通过访问<em>http://127.0.0.1:5984/_utils/</em>代替 <code>localhost</code> 来解决这个问题.

</div>

<p>在Futon的侧边栏上点击 "Test Suite" 来进入测试套件, 然后点击主页面上端的 "run all" 来开始测试. <a href="#figure/2">图2, "Futon测试套件"</a>显示Futon测试套件正在跑一些测试.

<div class="figure" id="figure/2">

<img src="tour/02.png">

<p class="caption">图2. Futon测试套件

</div>

<p>因为测试套件是从浏览器里跑的, 它不仅测试了CouchDB工作正常, 也验证了你的浏览器到数据库的连接设置正常, 这对于诊断不正常的代理或者其他HTTP中间件是很方便的.

<div class="aside warning">

<p>如果测试套件结果有过多的失败, 您需要查看下<a href="source.html">附录D, 从源代码安装</a>中的错误处理一节, 以便找到方法来修复您的安装.

</div>

<p>好了, 测试套件跑完后, 可以确认CouchDB安装已经成功, 来看看Futon还提供了哪些其他功能.

<h3 id="first">你的第一个数据库与文档</h3>

<p>在Futon里创建一个数据库很简单. 在overview页面点击 "Create Database". 当问你叫什么名字时, 键入 <code>hello-world</code> 然后点击Create按钮.

<p>当你的数据库创建以后, Futon会显示一个该数据库全部文档的列表, 如图3所示. 这个列表一开始会是空的(<a href="#figure/3">图3, "一个空的数据库"</a>), 那么我们来创建第一个文档吧. 点击Create Document来创建. 确保让文档ID为空, CouchDB会为你生成一个UUID.

<div class="aside warning">

<p>出于演示的目的, 让CouchDB来给UUID赋值没有问题. 在写您自己的第一个程序时, 我们建议自己来给UUID赋值. 如果你信赖于服务器来产生UUID, 那么可能会有这种情况. 你以为第一个POST请求丢失了, 因为没有响应回来, 而实际上并没有丢失. 结果你又做了一次相同的POST请求. 这样就会产生两个相同的文档而可能永远发现不了第一次产生的文档, 因为只有第二次的POST请求有响应回来. 使用自己的UUID就可以保证永远不会产生重复的文档.

</div>

<p>Futon会显示我们刚才新创建的文档, 这个文档只有<code>_id</code>和<code>rev</code>两个域. 创建一个新的域, 点击Add Field. 我们把新的域叫作<code>hello</code>. 点击绿色的勾按钮(或者按回车)来结束创建<code>hello</code>域. 双击<code>hello</code>域的值(默认是<code>null</code>)来编辑它.

<p>如果你键入<code>world</code>作为新值, 当你点击绿色勾勾时会得到一个错误. CouchDB的值必须是有效的JSON. 键入<code>"world"</code>(带双引号), 因为这是一个有效的JSON字符串, 这次保存它应该没有问题了. 你可以用另外的JSON值来试验一下, 比如 <code>[1, 2, "c"]</code> 或者 <code>{"foo":"bar"}</code>. 一旦你键入了值,  注意下_rev属性然后点击Save Document. 结果应该像<a href="#figure/4">图4一个"hello world"文档</a>所示.

<div class="figure" id="figure/3">

<img src="tour/03.png">

<p class="caption">图3. 一个空的数据库

</div>

<div class="figure" id="figure/4">

<img src="tour/04.png">

<p class="caption">图4. 一个"hello world"文档

</div>

<p>你会注意到文档的<code>_rev</code>已经改变了. 在后面的章节中我们会更细节的来看这个问题, 但是现在, 值得注意的事是当保存一个文档时, <code>_rev</code>表现为一个安全特性. 当你和CouchDB对文档的最新<code>_rev</code>达成一致, 你就能成功的保存改变.

<p>Futon也提供了一种方法来显示底层的JSON数据, 根据你在处理的是什么类型的数据, 可以展示的更紧凑并且更易读. 要看我们的Hello World文档的JSON版本, 点击Source tab, 结果应该像<a href="#figure/5">图5, "'hello world'文档的JSON源代码"</a>所示.

<div class="figure" id="figure/5">

<img src="tour/05.png">

<p class="caption">图5. "hello world"文档的JSON源代码

</div>

<h3 id="mapreduece">用MapReduce执行查询</h3>

<p>传统关系数据库允许你跑任何你喜欢的查询, 只要你的数据是正常的结构化的. 而CouchDB则使用预告定义的<em>map</em>和<em>reduce</em>函数, 一种被叫做MapReduce的风格. 这些函数提供了巨大的灵活性, 因为它们可以根据文档结构来产生不同变种, 并且每个文档的索引可以被独立和平行的计算. 一个map和一个reduce函数的组合在CouchDB的术语里被叫做<em>视图</em>.

<div class="aside note">

<p>对于有经验的关系数据库程序员来说, MapReduce可以需要慢慢的来适应. 关系数据库中要声明哪些表的哪些行应该出现在结果集中, 要根据不同的数据库决定如何最有效的查询数据, 而reduce查询则是以map函数产生的索引为基础的.

</div>

<p>Map函数每次调用都会使用一个文档作为参数. 函数可以选择跳过整个文档或者<em>使用</em>一行或多行key/value对. Map函数可以不依赖任何文档之外的信息. 这种独立性使得CouchDB视图可以增量和平行的生成.

<p>CouchDB视图是以key排序以行的形式被存储的. 这使得从一个keys范围中获取数据变得高效, 甚至当有成千上万行的时候. 在写CouchDB map函数的时候, 你的首要目标是建立一个索引, 这个索引存储相近key之间的相关数据.

<p>在我们执行一个MapReduce视图示例之前, 我们需要一些用来执行这个示例的数据. 我们会创建包含不同超市不同商品的价格的文档. 我们以苹果, 村子和香蕉为例子来创建文档. (允许CouchDB来生成<code>_id</code>和<code>_rev</code>域.) 使用Futon来创建文档, 最后产生的JSON结构看起来是这样:

<pre>
{
    "_id" : "bc2a41170621c326ec68382f846d5764",
    "_rev" : "2612672603",
    "item" : "apple",
    "prices" : {
        "Fresh Mart" : 1.59,
        "Price Max" : 5.99,
        "Apples Express" : 0.79
    }
}
</pre>

<p>这个文档应该如<a href="#figure/6">图6, 一个包含有苹果价格的示例文档</a>所示.

<div class="figure" id="figure/6">

<img src="tour/06.png">

<p class="caption">图6. 一个包含有苹果价格的示例文档

</div>

<p>好, 让我们再来创建桔子的文档:

<pre>
{
    "_id" : "bc2a41170621c326ec68382f846d5764",
    "_rev" : "2612672603",
    "item" : "orange",
    "prices" : {
        "Fresh Mart" : 1.99,
        "Price Max" : 3.19,
        "Citrus Circus" : 1.09
    }
}
</pre>

<p>最后, 香蕉的:

<pre>
{
    "_id" : "bc2a41170621c326ec68382f846d5764",
    "_rev" : "2612672603",
    "item" : "banana",
    "prices" : {
        "Fresh Mart" : 1.99,
        "Price Max" : 0.79,
        "Banana Montana" : 4.22
    }
}
</pre>

<p>想像一下, 我们正在做一个大型的午餐, 但是客户对价格很敏感. 为了找出最低的价格, 我们来创建我们的第一个视图, 它会根据价格排序显示每种水果. 点击hello-world来回到hello-world的overview页面, 然后从视图选择目录里选择Temporary view...来创建一个新视图. 结果应该如<a href="#figure/7">图7, "一个临时视图"</a>所示.

<div class="figure" id="figure/7">

<img src="tour/07.png">

<p class="caption">图7. 一个临时视图</p>

</div>

<p>编辑左边的map函数, 让它看起像这样子:

<pre>
function(doc) {
    var store, price, value;
    if (doc.item &amp;&amp; doc.prices) {
        for (store in doc.prices) {
            price = doc.prices[store];
            value = [doc.item, store];
            emit(price, value);
        }
    }
}
</pre>

<p>这是一个<em>JavaScript</em>函数, CouchDB会在每个文档上运行这个函数. 现在我们把Reduce函数暂时留空.

<p>点击Run, 然后你应该会看到如<a href="#figure/8">图8, "视图运行的结果"</a>的结果, 以价格排序的不同的物件. 如果把这些物件用类型排序, 这个map函数会更加有用, 这样所以香蕉的价格在结果集里都集中了. CouchDB的key排序系统允许任何有效的JSON对象作为一个key. 在这个例子中, 我们使用<code>[item, price]</code>这样一个数组, 这样CouchDB就能以物品类型和价格来进行分组

<div class="figure" id="figure/8">

<img src="tour/08.png">

<p class="caption">图8. 视图运行的结果

</div>

<p>让我们修改视图函数, 使它变成这样:

<pre>
function(doc) {
    var store, price, key;
    if (doc.item &amp;&amp; doc.prices) {
        for (store in doc.prices) {
            price = doc.prices[store];
            key = [doc.item, price];
            emit(key, store);
        }
    }
}
</pre>

<p>在这个函数中, 我们首先检查文档是否有我们想要使用的域. CouchDB可以从少量独立的map函数错误中优雅的恢复, 但是当一个map函数经常的发生错误(因为缺少需要的域或者其他JavaScript异常), CouchDB 会关闭它的索引来防止进一步的资源使用. 因为这个原因, 在使用它们之前检查域的存在是很重要的. 在这个例子里, 我们的map函数会跳过我们第一个"hello world"文档, 没有数据, 同时不会错误. 这个查询的结果应该如<a href="#figure/9">图9, "根据物品类型和价格进行分组后的视图运行结果"</a>所示.

<div class="figure" id="figure/9">

<img src="tour/09.png">

<p class="caption">图9. 根据物品类型和价格进行分组后的视图运行结果

</div>

<p>在得到了一个有物品类型和价格的文档后, 我们遍历物品的价格, 然后显示key/value对. key是一个物品和价格的数组. 在这个例子中, value则是这个价格的物品所在商场的名字.

<p>视图列表根据它们的key来排序, 在这个例子中: 首先是物件, 然后是价格. 这种复杂排序的方法是使用CouchDB创建有价值的索引的核心.

<div class="aside note">

<p>MapReduce可以变得很有挑战性, 特别是在你已经使用了多年的关系数据库后. 最重要的要记住的就是, map函数给了你以任何你选择的key来排序数据的机会, 而CouchDB的设计则关注于提供快速, 高效的依据key范围的数据访问.

</div>

<h3 id="replication">进行复制</h3>

<p>Futon可以在两个本地数据库, 一个本地数据库一个远端数据库, 或者甚至是两个远端数据库之间进行复制. 我们会向你展示, 如何从一个本地数据库复制数据到另一个, 这是一个简单的做数据库备份的方法.

<p>首先我们需要创建一个空数据库作为复制目标数据库. 回到overview页面然后创建一个叫<code>hello-replication</code>的数据库. 现在点击侧边栏里的Replicator, 并选择<code>hello-world</code>作为源, <code>hello-replication</code>作为目标. 点击"Relicate"来复制你的数据库. 结果应该如<a href="#figure/10">图10, "在Futon中运行数据库复制"</a>所示.

<div class="figure" id="figure/10">

<img src="tour/10.png">

<p class="caption">图10: 在Futon中运行数据库复制

</div>

<div class="aside warning">

<p>对于更大型的数据库来说, 复制会需要更长的时间. 在复制正在进行时, 保持浏览器窗口一直打开是很重要的. 也可以用另一种方式来进行复制, 可以通过<code>curl</code>或者其他的可以处理长时间连接的HTTP客户端. 如果在复制结果前, 客户端关闭了连接, 就必须要再次触发复制了. 幸运的是, CouchDB的复制可以在它中断的地方重新开始, 而不必重头再来.

</div>

<h3 id="wrap">收尾</h3>

<p>现在我们已经看过了Futon的大部分功能, 您已经可以进一步深入, 并且可以在后面章节构建示例应用时仔细观察下您的数据. Futon使用了纯粹的avaScript来实现CouchDB的管理, 这也向我们展示了如何只用CouchDB的HTTP API和内建Web Server来构建一个全功能的Web应用.

<p>但在我们讲到那之前, 我们用另一个角度来看看CouchDB的HTTP API; 这次我们会用放大镜--<em>curl</em>来看看.
